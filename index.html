<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan Data Harian Rinci - Firebase Cloud Storage</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
    <style>
        /* --- START: VARIABEL CSS KUSTOM UNTUK THEME --- */
        :root {
            /* Warna Mode Terang (Default) */
            --bg-body: #f4f7f6; 
            --bg-container: #ffffff;
            --bg-section: #f9f9f9; 
            --bg-input-group: #eceff1; 
            --bg-input-pair: #ffffff;
            --bg-input-khusus: #fbfbfb;
            --bg-calculated-input: #e3f2fd;
            --bg-chart-container: #ffffff;

            --color-text: #333;
            --color-header-main: #1a237e; 
            --color-header-secondary: #3949ab; 
            --color-header-tertiary: #00897b;
            --color-border-main: #e0e0e0;
            --color-border-sub: #cfd8dc;
            --color-shadow: rgba(0, 0, 0, 0.08);

            --bg-table-header: #3949ab;
            --bg-table-rj: #fffde7;
            --bg-table-ri: #e0f7fa;
            --bg-table-khusus: #ffe0b2;
            --bg-table-khusus-ket: #ffcc80;
            --bg-table-total: #c5cae9;
            --bg-total-div: #e8f5e9;
            --color-total-div: #2e7d32;
        }

        /* Gaya Mode Gelap (Dark Soft) */
        .dark-mode {
            --bg-body: #282c34; /* Dark Navy/Gray */
            --bg-container: #3c414c; /* Slightly Lighter Dark */
            --bg-section: #494e5a; 
            --bg-input-group: #525763; 
            --bg-input-pair: #494e5a;
            --bg-input-khusus: #525763;
            --bg-calculated-input: #62697b; /* Darker Blue Gray */
            --bg-chart-container: #494e5a;

            --color-text: #f0f0f0; /* Light Text */
            --color-header-main: #bb86fc; /* Bright Purple/Accent */
            --color-header-secondary: #03dac6; /* Teal/Cyan Accent */
            --color-header-tertiary: #a7ffeb; /* Light Teal Accent */
            --color-border-main: #585858;
            --color-border-sub: #6c707a;
            --color-shadow: rgba(0, 0, 0, 0.35);

            --bg-table-header: #bb86fc;
            --bg-table-rj: #525763; /* Darker RJ */
            --bg-table-ri: #446666; /* Darker RI */
            --bg-table-khusus: #665040; /* Darker Khusus */
            --bg-table-khusus-ket: #786050;
            --bg-table-total: #4c4a67;
            --bg-total-div: #3c414c;
            --color-total-div: #03dac6;
        }
        /* --- END: VARIABEL CSS KUSTOM UNTUK THEME --- */

        /* BASE STYLES - MENGGUNAKAN VARIABEL */
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-body); 
            color: var(--color-text); 
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s; /* Transisi untuk mode gelap */
        }

        .container {
            background-color: var(--bg-container);
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px var(--color-shadow); 
            max-width: 1400px; 
            width: 95%; 
            margin: auto; 
        }

        h1 {
            color: var(--color-header-main); 
            text-align: center;
            margin-bottom: 30px; 
            font-size: 2.2em;
            font-weight: 700; 
            border-bottom: 3px solid var(--color-border-main);
            padding-bottom: 10px;
        }

        h2 {
            color: var(--color-header-secondary); 
            border-left: 5px solid var(--color-header-secondary); 
            padding-left: 10px;
            margin-top: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.6em; 
        }

        h3 {
            color: var(--color-header-tertiary); 
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            width: 100%; 
        }

        /* INPUT & FORM STYLES */
        .input-section, .report-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background-color: var(--bg-section); 
            border: 1px solid var(--color-border-main);
        }

        label {
            color: var(--color-text); /* Menggunakan warna teks umum */
        }

        input[type="date"],
        select,
        textarea { /* Tambahkan textarea ke sini */
            width: 100%;
            padding: 10px; 
            margin-top: 0;
            margin-bottom: 15px; 
            border: 1px solid #bdbdbd; 
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: var(--bg-input-pair); /* Gunakan warna latar belakang input group */
            color: var(--color-text); /* Penting: agar teks input terlihat */
        }
        
        /* Menggunakan warna yang tetap untuk highlight/focus agar kontras */
        input:focus, select:focus, textarea:focus {
            border-color: #42a5f5; 
            box-shadow: 0 0 8px rgba(66, 165, 245, 0.4);
            outline: none;
        }

        /* ... [CSS untuk button, input-group, input-pair-wrapper dll. DIBIARKAN SAMA, HANYA MODIFIKASI WARNA DI BAWAH] ... */
        
        .input-group {
            margin-bottom: 25px; 
            padding: 20px 15px; 
            border: 1px solid var(--color-border-sub); 
            border-radius: 8px;
            background-color: var(--bg-input-group); 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .input-pair-wrapper {
            width: 48%; 
            margin-bottom: 25px;
            padding: 10px;
            border: 1px solid var(--color-border-sub);
            border-radius: 6px;
            background-color: var(--bg-input-pair); 
        }

        .main-label {
            color: var(--color-header-main); 
            border-bottom: 1px dotted var(--color-border-main);
        }
        
        .input-sub-item input[type="number"] {
            background-color: var(--bg-input-pair); 
            border: 1px solid #90a4ae; 
        }
        
        /* PENTING: Style untuk input yang dikalkulasi otomatis (read-only) */
        .input-item input[type="number"][readonly] {
            background-color: var(--bg-calculated-input); 
            font-weight: bold;
            color: var(--color-header-main);
        }

        .input-khusus-wrapper {
            border: 1px solid #b0bec5; 
            background-color: var(--bg-input-khusus);
        }
        
        .main-label-khusus {
            color: var(--color-header-tertiary); 
            border-bottom: 1px dashed var(--color-border-sub);
        }
        
        /* PENTING: Style untuk TEXTAREA */
        .input-khusus-keterangan textarea {
            background-color: var(--bg-input-pair);
        }
        
        /* TABLE STYLES - MENGGUNAKAN VARIABEL */
        #laporan-tabel {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px; 
            font-size: 0.8em; 
            table-layout: auto; 
        }

        #laporan-tabel th, #laporan-tabel td {
            border: 1px solid var(--color-border-main); 
            padding: 8px 6px; 
            text-align: left;
            min-width: 50px; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #laporan-tabel th {
            background-color: var(--bg-table-header); 
            color: white;
            text-align: center;
            font-size: 0.85em;
        }
        
        .total-row {
            font-weight: bold;
            background-color: var(--bg-table-total) !important; 
            color: var(--color-header-main);
        }
        
        /* Style untuk Kolom Total di format Transpose */
        #laporan-tabel tr td:last-child {
            background-color: var(--bg-table-total); 
            font-weight: bold;
        }
        
        /* KELAS WARNA BARIS */
        .row-rj td:not(:first-child):not(:last-child) {
            background-color: var(--bg-table-rj); 
        }

        .row-ri td:not(:first-child):not(:last-child) {
            background-color: var(--bg-table-ri); 
        }
        
        .row-umum td:not(:first-child):not(:last-child) {
            background-color: var(--bg-section); /* Warna section */
        }

        .row-khusus td:not(:first-child):not(:last-child) {
            background-color: var(--bg-table-khusus); 
        }

        .row-khusus .keterangan-cell {
            background-color: var(--bg-table-khusus-ket) !important; 
            font-weight: 500;
        }

        #laporan-tabel .total-row {
            background-color: var(--bg-table-total) !important; 
        }
        
        /* Border Vertikal Pemisah TEBAL */
        #laporan-tabel th:nth-child(7), 
        #laporan-tabel td:nth-child(7) {
            border-right: 3px solid var(--color-header-main); 
        }
        
        #laporan-tabel th:nth-child(21), 
        #laporan-tabel td:nth-child(21) {
            border-right: 3px solid var(--color-header-tertiary); 
        }


        #total-nilai {
            margin-top: 20px;
            font-size: 1.3em; 
            font-weight: bold;
            padding: 15px; 
            background-color: var(--bg-total-div); 
            border-radius: 8px;
            text-align: right;
            color: var(--color-total-div); 
            box-shadow: 0 2px 5px var(--color-shadow);
        }

        /* CHART CONTAINER */
        #chart-container {
            background-color: var(--bg-chart-container);
        }

        /* CHANGELOG */
        .changelog-section {
            background-color: #e0f2f1; /* Teal-White - KEEPING BRIGHT for contrast */
            border: 1px solid #b2dfdb;
        }

        .dark-mode .changelog-section {
            background-color: #55606e; /* Darker Teal for dark mode */
            border: 1px solid #78909c;
        }
        
        /* --- STYLE BARU UNTUK TOMBOL MODE GELAP --- */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        #toggle-theme-button {
            background-color: #607d8b; /* Blue-Gray */
            color: white;
            padding: 8px 15px; 
            font-size: 0.9em;
        }

        #toggle-theme-button:hover {
            background-color: #546e7a;
            transform: translateY(-1px);
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="theme-toggle">
            <span id="theme-status">Mode Terang</span>
            <button id="toggle-theme-button" onclick="toggleTheme()">‚òÄÔ∏è Ganti Mode</button>
        </div>
        
        <h1>üè• Input Data Harian Laporan Pelayanan (Cloud Firestore) <small style="font-size: 0.6em; color: #616161; font-weight: 400;">(Versi 1.2)</small></h1>
        
        <div class="input-section">
            <h2>Input Data Harian</h2>
            <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 20px; gap: 20px;">
                <label for="tanggal" style="margin-top:0; font-size: 1.1em; width: auto; flex-shrink: 0;">Tanggal:</label>
                <input type="date" id="tanggal" onchange="muatDataTanggal()" required style="width: 250px; margin-bottom: 0;">
            </div>
            
            <div class="input-group">
                <h3>1. Asuransi & Total Pasien</h3>
                
                <div class="input-pair-wrapper">
                    <label for="bpjsRj" class="main-label">Pasien BPJS</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="bpjsRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="bpjsRj" value="0" min="0" oninput="updateTotals()">
                        </div>
                        <div class="input-sub-item">
                            <label for="bpjsRi">Rawat Inap (RI):</label>
                            <input type="number" id="bpjsRi" value="0" min="0" oninput="updateTotals()">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="swastaRj" class="main-label">Pasien Swasta</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="swastaRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="swastaRj" value="0" min="0" oninput="updateTotals()">
                        </div>
                        <div class="input-sub-item">
                            <label for="swastaRi">Rawat Inap (RI):</label>
                            <input type="number" id="swastaRi" value="0" min="0" oninput="updateTotals()">
                        </div>
                    </div>
                </div>
                
                <div class="input-item">
                    <label for="totalPasien">Total Pasien (Semua):</label>
                    <input type="number" id="totalPasien" value="0" min="0" readonly>
                </div>
                <div class="input-item">
                    <label for="totalRi">Total Pasien Rawat Inap:</label>
                    <input type="number" id="totalRi" value="0" min="0" readonly>
                </div>
                <div class="input-item" style="height: 0; margin-bottom: 0; visibility: hidden;"></div> 
            </div>

            <div class="input-group">
                <h3>2. Data Spesialisasi</h3>
                
                <div class="input-pair-wrapper">
                    <label for="pdRi" class="main-label">Penyakit Dalam (PD)</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="pdRi">Rawat Inap (RI):</label>
                            <input type="number" id="pdRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="pdRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="pdRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="bedahRi" class="main-label">Bedah Umum</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="bedahRi">Rawat Inap (RI):</label>
                            <input type="number" id="bedahRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="bedahRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="bedahRj" value="0" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="input-pair-wrapper">
                    <label for="anakRi" class="main-label">Anak</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="anakRi">Rawat Inap (RI):</label>
                            <input type="number" id="anakRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="anakRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="anakRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="syarafRi" class="main-label">Syaraf</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="syarafRi">Rawat Inap (RI):</label>
                            <input type="number" id="syarafRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="syarafRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="syarafRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="obgynRi" class="main-label">Obgyn</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="obgynRi">Rawat Inap (RI):</label>
                            <input type="number" id="obgynRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="obgynRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="obgynRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="orthopediRi" class="main-label">Orthopedi</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="orthopediRi">Rawat Inap (RI):</label>
                            <input type="number" id="orthopediRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="orthopediRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="orthopediRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="mataRi" class="main-label">Mata</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="mataRi">Rawat Inap (RI):</label>
                            <input type="number" id="mataRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="mataRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="mataRj" value="0" min="0">
                        </div>
                    </div>
                </div>
                <div class="input-pair-wrapper" style="height: 0; margin-bottom: 0; visibility: hidden; padding: 0; border: none; background: none;"></div> 
            </div>

            <div class="input-group">
                <h3>3. Kejadian Khusus (Disertai Keterangan Multi-Baris)</h3>
                
                <div class="input-khusus-wrapper">
                    <label for="dirujuk" class="main-label-khusus">Pasien Dirujuk:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="dirujuk">Jumlah:</label>
                            <input type="number" id="dirujuk" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="dirujukKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="dirujukKeterangan" placeholder="Cth:&#10;1. Pasien A dirujuk ke RSUD X&#10;2. Pasien B dirujuk ke RS Y"></textarea>
                        </div>
                    </div>
                </div>

                <div class="input-khusus-wrapper">
                    <label for="ditolak" class="main-label-khusus">Pasien Ditolak:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="ditolak">Jumlah:</label>
                            <input type="number" id="ditolak" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="ditolakKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="ditolakKeterangan" placeholder="Cth:&#10;1. 1 kasus karena IGD penuh&#10;2. 1 kasus karena tidak ada kamar"></textarea>
                        </div>
                    </div>
                </div>

                <div class="input-khusus-wrapper">
                    <label for="rujukanMasuk" class="main-label-khusus">Pasien Rujukan (Masuk):</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="rujukanMasuk">Jumlah:</label>
                            <input type="number" id="rujukanMasuk" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="rujukanMasukKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="rujukanMasukKeterangan" placeholder="Cth:&#10;1. Rujukan dari Puskesmas X (DHF)&#10;2. Rujukan dari Bidan Y"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="input-khusus-wrapper">
                    <label for="meninggal" class="main-label-khusus">Pasien Meninggal < 8 Jam:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="meninggal">Jumlah:</label>
                            <input type="number" id="meninggal" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="meninggalKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="meninggalKeterangan" placeholder="Cth:&#10;1. Tn. A (Gagal Nafas)&#10;2. An. B (DHF Syok)"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="input-khusus-wrapper">
                    <label for="doa" class="main-label-khusus">Pasien DOA (Dead on Arrival):</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="doa">Jumlah:</label>
                            <input type="number" id="doa" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="doaKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="doaKeterangan" placeholder="Cth:&#10;1. Kecelakaan Lalu Lintas (Trauma Berat)&#10;2. Gantung Diri"></textarea>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="input-controls">
                <button onclick="tambahData()">‚úÖ Simpan/Perbarui Data Harian</button>
                <button onclick="hapusDataPerTanggal()" class="delete-date-button">‚ùå Hapus Data Tanggal Ini</button>
                <button onclick="resetInputFields(true)" class="reset-button">üîÑ Reset Input</button>
                <button onclick="hapusSemuaData()" class="delete-button">üóëÔ∏è Hapus Semua Data</button>
            </div>
        </div>

        <div class="report-section">
            <h2>Laporan Data Bulanan (Tanggal ke Samping)</h2>
            
            <div id="chart-container" style="max-width: 100%; height: 350px; margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background-color: var(--bg-chart-container);">
                <canvas id="monthly-chart"></canvas>
            </div>
            <div class="report-controls">
                <select id="bulan-filter" onchange="tampilkanLaporan()"></select>
                <button onclick="eksporLaporanXLSX_Transpose()" class="export-button" style="background-color: #1a237e;">
                    üì• Ekspor XLSX (Landscape)
                </button>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="laporan-tabel"></table>
            </div>
            
            <div id="total-nilai"></div>
        </div>
        
        <div class="changelog-section">
            <details>
                <summary>Riwayat Perubahan Aplikasi (Versi 1.2)</summary>
                <ul id="changelog-list-app" class="changelog-list">
                    <li class="changelog-item">
                        <strong>Versi 1.2 Update (Baru):</strong> Mengubah urutan kolom input Rawat Jalan (RJ) dan Rawat Inap (RI) di bagian 'Data Spesialisasi' menjadi **Rawat Inap (RI) &rarr; Rawat Jalan (RJ)** (sesuai permintaan user).
                    </li>
                    <li class="changelog-item">
                        <strong>1. Pindah Server (Versi 1.0):</strong> Menggunakan **Firebase Cloud Firestore** untuk menyimpan data harian.
                    </li>
                    <li class="changelog-item">
                        <strong>2. Pembaruan Laporan Visual (Versi 1.0):</strong> Perubahan tampilan grafik kunjungan pasien bulanan (menggunakan Chart.js).
                    </li>
                    <li class="changelog-item">
                        <strong>3. Format Ekspor Baru (Versi 1.0):</strong> Mengganti format file hasil laporan menjadi **XLSX** (sebelumnya CSV).
                    </li>
                    <li class="changelog-item">
                        <strong>4. Hapus Fungsi Lama (Versi 1.0):</strong> Menghapus fungsi ekspor file format CSV.
                    </li>
                </ul>
            </details>
            
            <details style="margin-top: 10px;">
                <summary style="font-size: 1.2em; font-weight: 600; color: #3949ab;">Riwayat Update Data Harian Terakhir</summary>
                <ul id="changelog-list" class="changelog-list">
                    <li>Memuat data perubahan...</li>
                </ul>
            </details>
        </div>
        </div>

    <script>
        // ... [KONFIGURASI FIREBASE DAN ARRAY DATA DIBIARKAN SAMA] ...
        const firebaseConfig = {
            apiKey: "AIzaSyD4CJjUxraBYsuBMPf8mJKOJI8-wbLGedQ",
            authDomain: "laporan-bulanan-b79f3.firebaseapp.com",
            projectId: "laporan-bulanan-b79f3",
            storageBucket: "laporan-bulanan-b79f3.firebasestorage.app",
            messagingSenderId: "662666112252",
            appId: "1:662666112252:web:31a296f176c6aead353b79",
            measurementId: "G-5S04HKJEL1"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const COLLECTION_NAME = 'laporanHarian';
        
        const INPUT_IDS = [
            'bpjsRj', 'bpjsRi', 'swastaRj', 'swastaRi', 'totalPasien', 'totalRi', 
            'pdRj', 'pdRi', 'bedahRj', 'bedahRi', 'anakRj', 'anakRi', 'syarafRj', 'syarafRi', 
            'obgynRj', 'obgynRi', 'orthopediRj', 'orthopediRi', 'mataRj', 'mataRi',
            'dirujuk', 'dirujukKeterangan', 
            'ditolak', 'ditolakKeterangan', 
            'rujukanMasuk', 'rujukanMasukKeterangan', 
            'meninggal', 'meninggalKeterangan', 
            'doa', 'doaKeterangan' 
        ];

        const dataKeysReport = [
            "tanggal", "bpjsRj", "bpjsRi", "swastaRj", "swastaRi", "totalPasien", "totalRi", 
            "pdRj", "pdRi", "bedahRj", "bedahRi", "anakRj", "anakRi", "syarafRj", "syarafRi", "obgynRj", "obgynRi", "orthopediRj", "orthopediRi", "mataRj", "mataRi",
            "dirujuk", "dirujukKeterangan", 
            "ditolak", "ditolakKeterangan", 
            "rujukanMasuk", "rujukanMasukKeterangan", 
            "meninggal", "meninggalKeterangan", 
            "doa", "doaKeterangan"
        ];
        
        const rowClassMap = {
            "BPJS RJ": "row-rj",
            "BPJS RI": "row-ri",
            "Swasta RJ": "row-rj",
            "Swasta RI": "row-ri",
            "Total Pasien": "row-umum",
            "Total RI": "row-umum",
            
            "PD RJ": "row-rj",
            "PD RI": "row-ri",
            "Bedah RJ": "row-rj",
            "Bedah RI": "row-ri",
            "Anak RJ": "row-rj",
            "Anak RI": "row-ri",
            "Syaraf RJ": "row-rj",
            "Syaraf RI": "row-ri",
            "Obgyn RJ": "row-rj",
            "Obgyn RI": "row-ri",
            "Orthopedi RJ": "row-rj",
            "Orthopedi RI": "row-ri",
            "Mata RJ": "row-rj",
            "Mata RI": "row-ri",
            
            "Dirujuk": "row-khusus",
            "Ket. Dirujuk": "row-khusus",
            "Ditolak": "row-khusus",
            "Ket. Ditolak": "row-khusus",
            "Rujukan Masuk": "row-khusus",
            "Ket. Masuk": "row-khusus",
            "Meninggal <8J": "row-khusus",
            "Ket. Meninggal": "row-khusus",
            "DOA": "row-khusus",
            "Ket. DOA": "row-khusus"
        };
        
        const kolomHeader = [
            "Tanggal", 
            "BPJS RJ", "BPJS RI", "Swasta RJ", "Swasta RI", "Total Pasien", "Total RI", 
            "PD RJ", "PD RI", "Bedah RJ", "Bedah RI", "Anak RJ", "Anak RI", "Syaraf RJ", "Syaraf RI", "Obgyn RJ", "Obgyn RI", "Orthopedi RJ", "Orthopedi RI", "Mata RJ", "Mata RI",
            "Dirujuk", "Ket. Dirujuk", 
            "Ditolak", "Ket. Ditolak", 
            "Rujukan Masuk", "Ket. Masuk", 
            "Meninggal <8J", "Ket. Meninggal", 
            "DOA", "Ket. DOA"
        ];
        
        // ... [FUNGSI-FUNGSI LAINNYA DIBIARKAN SAMA (muatChangelog, updateTotals, ambilSemuaDataLaporan, muatDataTanggal, hapusDataPerTanggal, resetInputFields, hapusSemuaData, tambahData, buatChartLaporan, inisialisasiBulanFilter, tampilkanLaporan, eksporLaporanXLSX_Transpose)] ...

        // Helper untuk memformat timestamp dari Firebase
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'Tanggal tidak valid';
            const date = timestamp.toDate();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit' 
            };
            return date.toLocaleString('id-ID', options);
        }

        // FUNGSI FIREBASE: MUAT RIWAYAT PERUBAHAN (CHANGELOG DATA)
        async function muatChangelog() {
            const listElement = document.getElementById('changelog-list');
            listElement.innerHTML = '<li>Memuat data perubahan...</li>';

            try {
                const snapshot = await db.collection(COLLECTION_NAME)
                                         .orderBy('timestamp', 'desc')
                                         .limit(10)
                                         .get();
                                         
                let htmlList = '';
                if (snapshot.empty) {
                    htmlList = '<li>Belum ada data harian yang tersimpan di Cloud Firestore.</li>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tanggal = data.tanggal;
                        const timestamp = data.timestamp;

                        const totalPasien = (data.totalPasien || 0); 
                        
                        const waktuUpdate = formatTimestamp(timestamp);

                        htmlList += `
                            <li class="changelog-item">
                                <strong>Laporan Tanggal: ${tanggal.split('-').reverse().join('/')}</strong> (Total Pasien: ${totalPasien.toLocaleString('id-ID')})
                                <br>
                                <small>Terakhir Disimpan/Diperbarui: ${waktuUpdate}</small>
                            </li>
                        `;
                    });
                }
                listElement.innerHTML = htmlList;

            } catch (error) {
                console.error("Gagal memuat changelog: ", error);
                listElement.innerHTML = '<li>Gagal memuat riwayat perubahan data. Cek konsol.</li>';
            }
        }
        
        // FUNGSI LOKAL: Kalkulasi Otomatis Total
        function updateTotals() {
            const bpjsRj = parseInt(document.getElementById('bpjsRj').value) || 0;
            const bpjsRi = parseInt(document.getElementById('bpjsRi').value) || 0;
            const swastaRj = parseInt(document.getElementById('swastaRj').value) || 0;
            const swastaRi = parseInt(document.getElementById('swastaRi').value) || 0;

            const totalPasien = bpjsRj + bpjsRi + swastaRj + swastaRi;
            const totalRi = bpjsRi + swastaRi; 

            document.getElementById('totalPasien').value = totalPasien;
            document.getElementById('totalRi').value = totalRi;
        }

        // FUNGSI FIREBASE BARU: AMBIL SEMUA DATA (untuk Laporan)
        async function ambilSemuaDataLaporan() {
            try {
                const snapshot = await db.collection(COLLECTION_NAME).orderBy('tanggal').get();
                const semuaData = [];
                snapshot.forEach(doc => {
                    semuaData.push(doc.data());
                });
                return semuaData;
            } catch (error) {
                console.error("Gagal mengambil semua data dari Firebase: ", error);
                alert("Gagal memuat data laporan dari cloud. Lihat konsol untuk detail.");
                return []; 
            }
        }
        
        // FUNGSI FIREBASE: MUAT DATA PER TANGGAL (READ)
        async function muatDataTanggal() {
            const tanggalInput = document.getElementById('tanggal').value;
            
            if (!tanggalInput) {
                resetInputFields(false);
                updateTotals();
                return;
            }

            try {
                const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                const doc = await docRef.get();

                if (doc.exists) {
                    const dataDitemukan = doc.data();
                    INPUT_IDS.forEach(id => {
                        const inputElement = document.getElementById(id);
                        if (inputElement) {
                            inputElement.value = dataDitemukan[id] !== undefined ? dataDitemukan[id] : 
                                (inputElement.tagName === 'INPUT' && inputElement.type === 'number' ? 0 : '');
                        }
                    });
                    console.log(`Data untuk tanggal ${tanggalInput} berhasil dimuat dari Firestore.`);
                } else {
                    resetInputFields(false); 
                    console.log(`Tidak ada data tersimpan untuk tanggal ${tanggalInput} di Firestore.`);
                }
            } catch (error) {
                 console.error("Gagal memuat data dari Firebase: ", error);
                 alert("Gagal memuat data. Lihat konsol untuk detailnya.");
            }
            updateTotals();
        }

        // FUNGSI FIREBASE: HAPUS DATA PER TANGGAL (DELETE)
        async function hapusDataPerTanggal() {
            const tanggalInput = document.getElementById('tanggal').value;
            
            if (!tanggalInput) {
                alert("Pilih tanggal terlebih dahulu untuk menghapus datanya!");
                return;
            }

            if (confirm(`Anda yakin ingin menghapus data untuk tanggal ${tanggalInput} dari Cloud Firestore? Aksi ini tidak bisa dibatalkan!`)) {
                try {
                    const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                    await docRef.delete();
                    
                    alert(`Data untuk tanggal ${tanggalInput} berhasil dihapus dari Cloud Firestore.`);
                    resetInputFields(false); 
                    await inisialisasiBulanFilter(); 
                    await tampilkanLaporan(); 
                    await muatChangelog(); 
                } catch (error) {
                    console.error("Gagal menghapus data dari Firebase: ", error);
                    alert("Gagal menghapus data. Pastikan Anda memiliki koneksi dan izin. Lihat konsol untuk detail.");
                }
            }
        }

        function resetInputFields(konfirmasiUser = true) {
            let lanjutkan = true;
            if (konfirmasiUser) {
                 lanjutkan = confirm("Anda yakin ingin MERESET semua kolom input data menjadi nilai 0/kosong?");
            }
            
            if (lanjutkan) {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                const textInputs = document.querySelectorAll('textarea');
                
                numberInputs.forEach(input => {
                    if (!input.hasAttribute('readonly')) {
                         input.value = 0;
                    }
                });
                
                textInputs.forEach(input => {
                    input.value = '';
                });

                updateTotals(); 
                
                if (konfirmasiUser) {
                    alert("Semua kolom input data telah direset menjadi 0/kosong.");
                }
            }
        }

        // FUNGSI FIREBASE: HAPUS SEMUA DATA (DELETE BATCH - sederhana)
        async function hapusSemuaData() {
            if (!confirm("PERINGATAN! ANDA YAKIN INGIN MENGHAPUS SEMUA DATA LAPORAN SECARA PERMANEN DARI CLOUD? Aksi ini tidak bisa dibatalkan!")) {
                return;
            }
            
            try {
                const batch = db.batch();
                const snapshot = await db.collection(COLLECTION_NAME).get();
                let count = 0;

                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                    count++;
                });

                await batch.commit();
                alert(`Semua ${count} data laporan telah berhasil dihapus dari Cloud Firestore.`);
                
                resetInputFields(false); 
                await inisialisasiBulanFilter(); 
                await tampilkanLaporan();  
                await muatChangelog();  
            } catch (error) {
                console.error("Gagal menghapus semua data dari Firebase: ", error);
                alert("Gagal menghapus semua data. Lihat konsol untuk detail.");
            }
        }

        // FUNGSI FIREBASE: SIMPAN/PERBARUI DATA (CREATE/UPDATE)
        async function tambahData() {
            const tanggalInput = document.getElementById('tanggal').value;

            if (!tanggalInput) {
                alert("Tanggal wajib diisi!");
                return;
            }

            updateTotals(); 

            // --- START: VALIDASI KONSISTENSI DATA ---
            const bpjsRj = parseInt(document.getElementById('bpjsRj').value) || 0;
            const bpjsRi = parseInt(document.getElementById('bpjsRi').value) || 0;
            const swastaRj = parseInt(document.getElementById('swastaRj').value) || 0;
            const swastaRi = parseInt(document.getElementById('swastaRi').value) || 0;

            const totalRjAsuransi = bpjsRj + swastaRj;
            const totalRiAsuransi = bpjsRi + swastaRi;

            const totalRjSpesialisasi = 
                (parseInt(document.getElementById('pdRj').value) || 0) +
                (parseInt(document.getElementById('bedahRj').value) || 0) +
                (parseInt(document.getElementById('anakRj').value) || 0) +
                (parseInt(document.getElementById('syarafRj').value) || 0) +
                (parseInt(document.getElementById('obgynRj').value) || 0) +
                (parseInt(document.getElementById('orthopediRj').value) || 0) +
                (parseInt(document.getElementById('mataRj').value) || 0);

            const totalRiSpesialisasi = 
                (parseInt(document.getElementById('pdRi').value) || 0) +
                (parseInt(document.getElementById('bedahRi').value) || 0) +
                (parseInt(document.getElementById('anakRi').value) || 0) +
                (parseInt(document.getElementById('syarafRi').value) || 0) +
                (parseInt(document.getElementById('obgynRi').value) || 0) +
                (parseInt(document.getElementById('orthopediRi').value) || 0) +
                (parseInt(document.getElementById('mataRi').value) || 0);

            let errorMessages = [];

            if (totalRjAsuransi !== totalRjSpesialisasi) {
                errorMessages.push(`‚ùå Total Pasien Rawat Jalan (Asuransi: ${totalRjAsuransi}) TIDAK SAMA dengan Total Pasien Rawat Jalan (Spesialisasi: ${totalRjSpesialisasi}).`);
            }

            if (totalRiAsuransi !== totalRiSpesialisasi) {
                errorMessages.push(`‚ùå Total Pasien Rawat Inap (Asuransi: ${totalRiAsuransi}) TIDAK SAMA dengan Total Pasien Rawat Inap (Spesialisasi: ${totalRiSpesialisasi}).`);
            }

            if (errorMessages.length > 0) {
                const konfirmasiLanjut = confirm("‚ö†Ô∏è Data Pasien Tidak Konsisten! \n\n" + errorMessages.join('\n') + "\n\nApakah Anda yakin ingin tetap menyimpan data ini?");
                if (!konfirmasiLanjut) {
                    alert("Penyimpanan data dibatalkan. Mohon periksa kembali kolom Asuransi dan Spesialisasi.");
                    return;
                }
            }
            // --- END: VALIDASI KONSISTENSI DATA ---

            const dataBaru = { 
                tanggal: tanggalInput,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            INPUT_IDS.forEach(id => {
                 const inputElement = document.getElementById(id);
                 if (inputElement.tagName === 'INPUT' && inputElement.type === 'number') {
                    dataBaru[id] = parseInt(inputElement.value) || 0;
                 } else if (inputElement.tagName === 'TEXTAREA') {
                    dataBaru[id] = inputElement.value.trim(); 
                 }
            });
            
            try {
                 const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                 const doc = await docRef.get();

                 let konfirmasiPesan;
                 if (doc.exists) {
                     konfirmasiPesan = `Anda yakin ingin MEMPERBARUI data untuk tanggal ${tanggalInput} di Cloud Firestore?`;
                 } else {
                     konfirmasiPesan = `Anda yakin ingin MENYIMPAN data baru untuk tanggal ${tanggalInput} di Cloud Firestore?`;
                 }

                 if (confirm(konfirmasiPesan)) {
                     await docRef.set(dataBaru);
                     alert(`Data untuk tanggal ${tanggalInput} berhasil disimpan/diperbarui di Cloud Firestore!`);

                     await inisialisasiBulanFilter(); 
                     await tampilkanLaporan(); 
                     await muatChangelog();
                 } else {
                      alert("Penyimpanan/Pembaruan data dibatalkan.");
                 }
            } catch (error) {
                console.error("Gagal menyimpan data ke Firebase: ", error);
                alert("Gagal menyimpan data. Pastikan Anda memiliki koneksi dan izin. Lihat konsol untuk detail.");
            }
        }
        
        let monthlyChart = null; 

        function buatChartLaporan(dataBulanIni) {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const dates = dataBulanIni.map(item => item.tanggal.split('-').reverse().join('/'));
            const totalPasienHarian = dataBulanIni.map(item => item.totalPasien);
            
            // Perbarui warna Chart sesuai mode
            const isDarkMode = document.body.classList.contains('dark-mode');
            const borderColor = isDarkMode ? 'rgb(3, 218, 198)' : 'rgb(66, 165, 245)';
            const backgroundColor = isDarkMode ? 'rgba(3, 218, 198, 0.5)' : 'rgba(66, 165, 245, 0.5)';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDarkMode ? '#f0f0f0' : '#333';

            monthlyChart = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Total Pasien Harian',
                        data: totalPasienHarian,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: labelColor 
                            }
                        },
                        title: {
                            display: true,
                            text: 'üìà Tren Total Pasien Harian Bulan Ini',
                            font: { size: 16, color: labelColor }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: labelColor },
                            title: { display: true, text: 'Tanggal', color: labelColor }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: labelColor },
                            title: { display: true, text: 'Jumlah Pasien', color: labelColor }
                        }
                    }
                }
            });
        }


        // FUNGSI FIREBASE: INISIALISASI FILTER BULAN
        async function inisialisasiBulanFilter() {
            const data = await ambilSemuaDataLaporan();
            const filter = document.getElementById('bulan-filter');
            filter.innerHTML = ''; 

            const bulanTersedia = new Set();
            data.forEach(item => {
                const [tahun, bulan] = item.tanggal.split('-');
                bulanTersedia.add(`${tahun}-${bulan}`);
            });

            const bulanArray = Array.from(bulanTersedia).sort().reverse();
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Pilih Bulan --';
            filter.appendChild(defaultOption);

            bulanArray.forEach(bulanTahun => {
                const option = document.createElement('option');
                option.value = bulanTahun;
                const [tahun, bulan] = bulanTahun.split('-');
                const namaBulan = new Date(tahun, bulan - 1).toLocaleString('id-ID', { month: 'long' });
                option.textContent = `${namaBulan} ${tahun}`;
                filter.appendChild(option);
            });

            if (bulanArray.length > 0) {
                filter.value = bulanArray[0];
            }
        }

        // FUNGSI FIREBASE: TAMPILKAN LAPORAN (READ)
        async function tampilkanLaporan() {
            const bulanFilter = document.getElementById('bulan-filter').value;
            const tabelContainer = document.getElementById('laporan-tabel');
            const totalDiv = document.getElementById('total-nilai');
            
            const semuaData = await ambilSemuaDataLaporan();
            tabelContainer.innerHTML = '';
            totalDiv.textContent = '';
            
            if (!bulanFilter) {
                totalDiv.textContent = 'Silahkan pilih bulan untuk menampilkan laporan.';
                if (monthlyChart) monthlyChart.destroy();
                return;
            }

            const dataBulanIni = semuaData.filter(item => item.tanggal.startsWith(bulanFilter));

            if (dataBulanIni.length === 0) {
                tabelContainer.innerHTML = '<thead><tr><th>Kategori</th></tr></thead><tbody><tr><td colspan="31" style="text-align:center;">Tidak ada data untuk bulan yang dipilih.</td></tr></tbody>';
                if (monthlyChart) monthlyChart.destroy();
                return;
            }

            const reportDataKeys = dataKeysReport.slice(1);
            const reportKolomHeader = kolomHeader.slice(1);
            
            const dates = dataBulanIni.map(item => item.tanggal.split('-').reverse().join('/')); 

            const headerRow = tabelContainer.createTHead().insertRow();
            
            let th = document.createElement('th');
            th.textContent = 'Kategori';
            th.style.minWidth = '150px'; 
            headerRow.appendChild(th);

            dates.forEach(date => {
                th = document.createElement('th');
                th.textContent = date;
                headerRow.appendChild(th);
            });

            th = document.createElement('th');
            th.textContent = 'TOTAL BULAN';
            th.style.backgroundColor = 'var(--color-header-main)'; /* Gunakan variabel CSS */
            headerRow.appendChild(th);

            const tabelBody = tabelContainer.createTBody();
            
            let totalPasienBulanIni = 0;

            reportKolomHeader.forEach((displayHeader, index) => {
                const dataKey = reportDataKeys[index]; 
                const row = tabelBody.insertRow();
                
                const rowClass = rowClassMap[displayHeader] || 'row-umum';
                row.classList.add(rowClass);

                let cell = row.insertCell();
                cell.textContent = displayHeader;
                cell.style.fontWeight = 'bold';
                
                let totalMetric = 0;
                
                dataBulanIni.forEach(dayData => {
                    cell = row.insertCell();
                    const value = dayData[dataKey];

                    if (displayHeader.includes('Ket.')) {
                        cell.textContent = value || '-';
                        cell.classList.add('keterangan-cell');
                        cell.style.textAlign = 'left';
                        
                    } else {
                        const numValue = parseInt(value) || 0;
                        cell.textContent = numValue;
                        cell.style.textAlign = 'right';
                        totalMetric += numValue;
                        
                        if (dataKey === 'totalPasien') {
                            totalPasienBulanIni += numValue;
                        }
                    }
                });
                
                cell = row.insertCell();
                if (displayHeader.includes('Ket.')) {
                    cell.textContent = '-'; 
                    cell.style.textAlign = 'center';
                    cell.classList.add('keterangan-cell');
                } else {
                    cell.textContent = totalMetric.toLocaleString('id-ID');
                    cell.style.textAlign = 'right';
                    cell.classList.add('total-row'); 
                }
            });

            totalDiv.textContent = `TOTAL PASIEN BULAN INI: ${totalPasienBulanIni.toLocaleString('id-ID')}`;
            
            const totalHarianRow = tabelBody.insertRow();
            totalHarianRow.classList.add('total-row'); 
            totalHarianRow.style.backgroundColor = 'var(--bg-total-div)'; 

            let cellLabel = totalHarianRow.insertCell();
            cellLabel.textContent = 'TOTAL HARIAN (Semua Pasien)';
            cellLabel.style.textAlign = 'left';
            cellLabel.style.fontWeight = 'bold';
            
            dataBulanIni.forEach(dayData => {
                let cellTotal = totalHarianRow.insertCell();
                const dailyTotal = dayData.totalPasien || 0; 
                cellTotal.textContent = dailyTotal.toLocaleString('id-ID');
                cellTotal.style.textAlign = 'right';
                cellTotal.style.fontWeight = 'bold';
                cellTotal.style.backgroundColor = 'var(--bg-table-total)'; 
            });

            let cellGrandTotal = totalHarianRow.insertCell();
            cellGrandTotal.textContent = totalPasienBulanIni.toLocaleString('id-ID');
            cellGrandTotal.style.textAlign = 'right';
            cellGrandTotal.style.fontWeight = 'bold';
            cellGrandTotal.style.backgroundColor = '#2e7d32'; 
            cellGrandTotal.style.color = 'white';

            buatChartLaporan(dataBulanIni); 
        }

        // FUNGSI EKSPOR XLSX (LANDSCAPE/TRANSPOSE) - DIBIARKAN SAMA
        async function eksporLaporanXLSX_Transpose() {
            const bulanFilter = document.getElementById('bulan-filter').value;
            if (!bulanFilter) {
                alert("Pilih bulan terlebih dahulu untuk diekspor!");
                return;
            }

            const semuaData = await ambilSemuaDataLaporan();
            const dataBulanIni = semuaData.filter(item => item.tanggal.startsWith(bulanFilter));
            
            if (dataBulanIni.length === 0) {
                 alert("Tidak ada data untuk diekspor.");
                 return;
            }

            const reportDataKeys = dataKeysReport.slice(1);
            const reportKolomHeader = kolomHeader.slice(1); 

            let finalDataXLSX = [];
            
            const dates = dataBulanIni.map(item => item.tanggal.split('-')[2]); 
            
            const headerRow = ["Kategori", ...dates, "TOTAL BULAN"];
            finalDataXLSX.push(headerRow);
            
            let totalPasienBulanIni = 0; 

            reportKolomHeader.forEach((displayHeader, index) => {
                const dataKey = reportDataKeys[index]; 
                const row = [displayHeader]; 
                
                let totalMetric = 0;
                
                dataBulanIni.forEach(dayData => {
                    const value = dayData[dataKey];

                    if (displayHeader.includes('Ket.')) {
                        const ketValue = String(value || '').replace(/\n/g, ' | '); 
                        row.push(ketValue);
                    } else {
                        const numValue = parseInt(value) || 0;
                        row.push(numValue);
                        totalMetric += numValue;
                        
                        if (dataKey === 'totalPasien') {
                            totalPasienBulanIni += numValue;
                        }
                    }
                });
                
                row.push(displayHeader.includes('Ket.') ? '' : totalMetric);
                
                finalDataXLSX.push(row);
            });

            let totalHarianRow = ["TOTAL HARIAN"]; 
            
            const totalPasienDataIndex = reportDataKeys.indexOf('totalPasien'); 

            dates.forEach((date, dateIndex) => {
                const dailyTotal = finalDataXLSX[totalPasienDataIndex + 1] ? finalDataXLSX[totalPasienDataIndex + 1][dateIndex + 1] : 0; 
                totalHarianRow.push(dailyTotal || 0);
            });
            totalHarianRow.push(totalPasienBulanIni); 
            finalDataXLSX.push(totalHarianRow);

            const ws = XLSX.utils.aoa_to_sheet(finalDataXLSX); 
            
            // --- START: MODIFIKASI STYLING XLSX (Warna dan Freeze Pane) ---
            
            // Tetap gunakan warna statis yang sama di XLSX untuk konsistensi di dokumen
            const styles = {
                header: { fill: { patternType: "solid", fgColor: { rgb: "3949AB" } }, font: { color: { rgb: "FFFFFF" }, bold: true } }, 
                totalBulan: { fill: { patternType: "solid", fgColor: { rgb: "E8EAF6" } }, font: { bold: true } }, 
                grandTotal: { fill: { patternType: "solid", fgColor: { rgb: "E8F5E9" } }, font: { bold: true, color: { rgb: "2E7D32" } } }, 
                rj: { fill: { patternType: "solid", fgColor: { rgb: "FFFDE7" } } }, 
                ri: { fill: { patternType: "solid", fgColor: { rgb: "E0F7FA" } } }, 
                khusus: { fill: { patternType: "solid", fgColor: { rgb: "FFE0B2" } } } 
            };

            for (let R = 0; R < finalDataXLSX.length; ++R) {
                const rowData = finalDataXLSX[R];
                const category = String(rowData[0]); 

                for (let C = 0; C < rowData.length; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = ws[cellAddress]; 

                    if (cell) {
                        let cellStyle = {};
                        
                        if (R === 0) {
                            cellStyle = styles.header;
                        } else if (category === 'TOTAL HARIAN') {
                            if (C === rowData.length - 1) {
                                 cellStyle = { ...styles.grandTotal, fill: styles.grandTotal.fill, font: { ...styles.grandTotal.font, color: { rgb: "FFFFFF" } } };
                            } else {
                                 cellStyle = styles.grandTotal; 
                            }
                            
                        } else if (C === rowData.length - 1) {
                            cellStyle = styles.totalBulan;
                        } else {
                            if (category.includes('RJ') && !category.includes('Ket.')) {
                                cellStyle = styles.rj;
                            } else if (category.includes('RI') && !category.includes('Ket.')) {
                                cellStyle = styles.ri;
                            } else if (category.includes('Dirujuk') || category.includes('Ditolak') || category.includes('Rujukan Masuk') || category.includes('Meninggal') || category.includes('DOA') || category.includes('Ket.')) {
                                 cellStyle = styles.khusus;
                            }
                        }
                        
                        cell.s = { ...cell.s, ...cellStyle }; 
                    }
                }
            }

            ws['!freeze'] = { xSplit: 1, ySplit: 1 };
            
            // --- END: MODIFIKASI STYLING XLSX ---


            const wscols = [];
            wscols.push({wch: 25}); 
            for(let i = 0; i < dates.length; i++) {
                 wscols.push({wch: 6}); 
            }
            wscols.push({wch: 15}); 
            ws['!cols'] = wscols;

            if (!ws['!page']) ws['!page'] = {};
            
            ws['!page'].orientation = 'landscape'; 
            ws['!page'].fitToPage = true;   
            ws['!page'].fitToWidth = 1;     
            ws['!page'].fitToHeight = 0;    

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Transpose");

            const [tahun, bulan] = bulanFilter.split('-');
            const namaFile = `Laporan_Transpose_XLSX_Compact_${tahun}_${bulan}.xlsx`;
            
            XLSX.writeFile(wb, namaFile);
            
            alert(`Laporan XLSX Transpose Compact untuk bulan ${bulanFilter} berhasil diekspor.`);
        }

        // --- START: FUNGSI MODE GELAP ---
        
        // FUNGSI UTAMA UNTUK MENGGANTI TEMA
        function toggleTheme() {
            const body = document.body;
            const isDarkMode = body.classList.toggle('dark-mode');
            
            // Simpan preferensi pengguna di localStorage
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            
            // Perbarui teks tombol/status
            updateThemeStatus(isDarkMode);
            
            // Perbarui Chart.js setelah perubahan mode
            if (monthlyChart) {
                // Hancurkan dan buat ulang chart agar warna diperbarui
                const dataBulanIni = monthlyChart.data.labels.map((label, index) => ({
                    tanggal: label.split('/').reverse().join('-'), // Konversi kembali ke format YYYY-MM-DD
                    totalPasien: monthlyChart.data.datasets[0].data[index]
                }));
                buatChartLaporan(dataBulanIni); 
            }
        }
        
        // FUNGSI UNTUK MEMPERBARUI TAMPILAN TOMBOL
        function updateThemeStatus(isDarkMode) {
            const statusElement = document.getElementById('theme-status');
            const buttonElement = document.getElementById('toggle-theme-button');
            
            if (isDarkMode) {
                statusElement.textContent = 'Mode Gelap';
                buttonElement.innerHTML = '‚òÄÔ∏è Ganti Mode';
                buttonElement.style.backgroundColor = '#03dac6'; // Teal untuk Mode Gelap
            } else {
                statusElement.textContent = 'Mode Terang';
                buttonElement.innerHTML = 'üåô Ganti Mode';
                buttonElement.style.backgroundColor = '#607d8b'; // Blue-Gray untuk Mode Terang
            }
        }

        // FUNGSI UNTUK MENGAPLIKASIKAN TEMA SAAT PERTAMA KALI MEMUAT
        function applyInitialTheme() {
            // Cek preferensi dari localStorage
            const savedTheme = localStorage.getItem('theme');
            // Cek preferensi sistem
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            let isDarkMode = false;
            
            if (savedTheme === 'dark') {
                isDarkMode = true;
            } else if (savedTheme === 'light') {
                isDarkMode = false;
            } else if (prefersDark) {
                // Jika tidak ada di localStorage, ikuti preferensi sistem
                isDarkMode = true;
            }

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }
            
            updateThemeStatus(isDarkMode);
        }

        // --- END: FUNGSI MODE GELAP ---

        window.onload = async function() {
            // 1. Terapkan tema awal (dari localStorage/preferensi sistem)
            applyInitialTheme();

            // 2. Set tanggal hari ini
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const defaultDate = `${year}-${month}-${day}`;
            
            document.getElementById('tanggal').value = defaultDate;
            
            // 3. Memuat data dan laporan
            await muatDataTanggal(); 
            await inisialisasiBulanFilter();
            await tampilkanLaporan();
            await muatChangelog();
        };
    </script>
</body>
</html>
