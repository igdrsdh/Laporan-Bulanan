<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Laporan Data Harian Rinci - Firebase Cloud Storage</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
    <style>
        /* BASE STYLES - TEMA BARU: Profesional & Rapi */
        body {
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6; /* Off-white / Light Gray */
            color: #333; /* Dark text */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            /* MENAMBAH LEBAR MAKSIMUM & PUSAT */
            background-color: #ffffff;
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); /* Shadow yang lebih halus */
            max-width: 1400px; 
            width: 95%; 
            margin: auto; 
        }

        h1 {
            color: #1a237e; /* Deep Blue Header */
            text-align: center;
            margin-bottom: 30px; 
            font-size: 2.2em;
            font-weight: 700; 
            border-bottom: 3px solid #e0e0e0;
            padding-bottom: 10px;
        }

        h2 {
            color: #3949ab; /* Blue Accent */
            border-left: 5px solid #3949ab; 
            padding-left: 10px;
            margin-top: 25px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.6em; 
        }

        h3 {
            color: #00897b; /* Teal Accent */
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            width: 100%; /* Agar judul group penuh */
        }

        /* INPUT & FORM STYLES */
        .input-section, .report-section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background-color: #f9f9f9; 
            border: 1px solid #e0e0e0;
        }

        label {
            display: block;
            margin-top: 5px;
            font-weight: 500; 
            margin-bottom: 5px;
            color: #555; 
        }

        input[type="date"],
        select {
            width: 100%;
            padding: 10px; 
            margin-top: 0;
            margin-bottom: 15px; 
            border: 1px solid #bdbdbd; 
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #ffffff;
        }
        input:focus, select:focus {
            border-color: #42a5f5; /* Light Blue Focus */
            box-shadow: 0 0 8px rgba(66, 165, 245, 0.4);
            outline: none;
        }

        button {
            background-color: #43a047; /* Green Save */
            color: white;
            padding: 10px 20px; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em; 
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0; 
        }

        button:hover {
            background-color: #388e3c; 
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        button.export-button {
            background-color: #fb8c00; /* Orange Export */
            margin-right: 0 !important;
        }
        button.export-button:hover {
            background-color: #f57c00; 
        }

        button.reset-button {
            background-color: #ffb300; /* Amber Yellow Reset */
        }
        button.reset-button:hover {
            background-color: #ff8f00; 
        }

        button.delete-button {
            background-color: #e53935; /* Red Delete All Data */
        }
        button.delete-button:hover {
            background-color: #c62828; 
        }
        
        /* TOMBOL BARU: Hapus Data Tanggal Ini */
        button.delete-date-button {
            background-color: #8c0000; /* Darker Red for specific deletion */
        }
        button.delete-date-button:hover {
            background-color: #6d0000; 
        }
        
        /* INPUT GROUPS - LAYOUT UMUM */
        .input-group {
            margin-bottom: 25px; 
            padding: 20px 15px; 
            border: 1px solid #cfd8dc; 
            border-radius: 8px;
            background-color: #eceff1; 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        /* 1. INPUT BERPASANGAN (ASURANSI & SPESIALISASI) */
        .input-pair-wrapper {
            width: 48%; /* 2 kolom utama di desktop */
            margin-bottom: 25px;
            padding: 10px;
            border: 1px solid #cfd8dc;
            border-radius: 6px;
            background-color: #ffffff; 
        }

        .main-label {
            font-weight: 600;
            color: #1a237e; 
            display: block;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #ccc;
            font-size: 1.1em;
        }
        
        .input-sub-pair {
            display: flex;
            gap: 15px;
        }
        
        .input-sub-item {
            flex-grow: 1;
        }
        .input-sub-item label {
            font-weight: 400; 
            color: #555;
            font-size: 0.9em;
            margin-top: 0;
            margin-bottom: 2px;
        }
        .input-sub-item input[type="number"] {
            width: 100%;
            padding: 8px; 
            margin: 0;
            text-align: left; 
            box-sizing: border-box;
            background-color: #fff; 
            border: 1px solid #90a4ae; 
        }

        /* 2. INPUT TUNGGAL (TOTALS) */
        .input-item {
            display: flex;
            flex-direction: column;
            width: 30%; 
            margin-bottom: 15px; 
        }
        .input-item input[type="number"] {
             padding: 10px; 
            margin: 0;
            text-align: left; 
            box-sizing: border-box;
            background-color: #fff; 
            border: 1px solid #90a4ae; 
        }

        /* PENTING: Style untuk input yang dikalkulasi otomatis (read-only) */
        .input-item input[type="number"][readonly] {
            background-color: #e3f2fd; /* Light blue background for calculated fields */
            font-weight: bold;
            color: #1a237e;
        }

        /* ************************************** */
        /* PENYESUAIAN KHUSUS UNTUK KEJADIAN KHUSUS (SECTION 3) */
        /* ************************************** */
        .input-khusus-wrapper {
            width: 100%; /* Setiap item Kejadian Khusus mengambil 100% lebar */
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #b0bec5; /* Light Blue-Gray border */
            border-radius: 6px;
            background-color: #fbfbfb;
        }
        
        .main-label-khusus {
            font-weight: 600;
            color: #00897b; /* Teal color */
            display: block;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px dashed #cfd8dc;
            font-size: 1.05em;
        }
        
        .input-sub-pair-khusus {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .input-khusus-jumlah {
            flex-basis: 150px; /* Lebar tetap untuk input jumlah */
            flex-shrink: 0;
        }
        
        .input-khusus-keterangan {
            flex-grow: 1; /* Mengambil sisa ruang untuk keterangan */
        }
        
        /* PENTING: Style untuk TEXTAREA */
        .input-khusus-keterangan textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 0;
            border: 1px solid #bdbdbd;
            border-radius: 6px;
            box-sizing: border-box;
            resize: vertical; /* Hanya izinkan resize vertikal */
            min-height: 80px; /* Ketinggian minimum agar bisa menampilkan list */
        }

        /* Penyesuaian Responsif */
        @media (max-width: 1200px) {
            .input-pair-wrapper {
                width: 100%; 
            }
            .input-item {
                width: 48%; 
            }
        }
        @media (max-width: 768px) {
            .input-sub-pair-khusus {
                flex-direction: column; /* Tumpuk di layar kecil */
                gap: 5px;
            }
            .input-khusus-jumlah {
                flex-basis: auto;
                width: 100%;
                margin-bottom: 10px;
            }
            .input-item {
                width: 48%; 
            }
        }
        @media (max-width: 600px) {
             .input-item {
                width: 100%; 
            }
        }
        
        .input-item input[type="number"]:not([readonly]):focus,
        .input-sub-item input[type="number"]:focus,
        .input-khusus-keterangan textarea:focus { 
             border-color: #00acc1; 
             box-shadow: 0 0 6px rgba(0, 172, 193, 0.4);
        }
        
        /* TABLE STYLES */
        #laporan-tabel {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px; 
            font-size: 0.8em; 
            table-layout: auto; 
        }

        #laporan-tabel th, #laporan-tabel td {
            border: 1px solid #e0e0e0; 
            padding: 8px 6px; 
            text-align: left;
            min-width: 50px; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #laporan-tabel th {
            background-color: #3949ab; 
            color: white;
            text-align: center;
            font-size: 0.85em;
        }
        
        #laporan-tabel td.keterangan-cell {
            min-width: 150px; 
            max-width: 300px;
            white-space: pre-wrap; 
            text-overflow: clip; 
            overflow: visible; 
            font-size: 0.75em; 
        }
        
        .total-row {
            font-weight: bold;
            background-color: #c5cae9 !important; 
            color: #1a237e;
        }
        
        /* Style untuk Kolom Total di format Transpose */
        #laporan-tabel tr td:last-child {
            background-color: #e8eaf6; 
            font-weight: bold;
        }
        
        /* ************************************** */
        /* PENAMBAHAN STYLE KUSTOM UNTUK LAPORAN TRANSPOSE */
        /* ************************************** */

        /* Kelas untuk baris Rawat Jalan (RJ) */
        .row-rj td:not(:first-child):not(:last-child) {
            background-color: #fffde7; /* Krem Muda (Light Yellow) */
        }

        /* Kelas untuk baris Rawat Inap (RI) */
        .row-ri td:not(:first-child):not(:last-child) {
            background-color: #e0f7fa; /* Biru Muda (Light Cyan) */
        }
        
        /* Kelas untuk baris Umum/Lainnya */
        .row-umum td:not(:first-child):not(:last-child) {
            background-color: #f5f5f5; /* Warna netral */
        }

        /* Kelas untuk baris Kejadian Khusus */
        .row-khusus td:not(:first-child):not(:last-child) {
            background-color: #ffe0b2; /* Oranye muda untuk Kejadian Khusus */
        }

        /* Override khusus untuk cell KETERANGAN di Kejadian Khusus agar menonjol */
        .row-khusus .keterangan-cell {
            background-color: #ffcc80 !important; /* Oranye sedikit lebih tua */
            font-weight: 500;
        }

        /* Penting: Pastikan baris total tetap menggunakan warna aslinya */
        /* KECUALI yang baru ditambahkan (TOTAL HARIAN) */
        #laporan-tabel .total-row {
            background-color: #e8eaf6 !important; 
        }
        
        /* Border Vertikal Pemisah TEBAL */
        /* 1. Pemisah antara TOTAL PASIEN & SPESIALISASI: Kolom 'Total RI' (index 6 dari kolom data) */
        /* Ini adalah kolom ke-7 dari kiri (kolom Kategori adalah ke-1) */
        #laporan-tabel th:nth-child(7), 
        #laporan-tabel td:nth-child(7) {
            border-right: 3px solid #1a237e; /* Border Biru Tua */
        }
        
        /* 2. Pemisah antara SPESIALISASI & KEJADIAN KHUSUS: Kolom 'Mata RI' (index 19 dari kolom data) */
        /* Ini adalah kolom ke-21 dari kiri */
        #laporan-tabel th:nth-child(21), 
        #laporan-tabel td:nth-child(21) {
            border-right: 3px solid #00897b; /* Border Teal */
        }


        #total-nilai {
            margin-top: 20px;
            font-size: 1.3em; 
            font-weight: bold;
            padding: 15px; 
            background-color: #e8f5e9; 
            border-radius: 8px;
            text-align: right;
            color: #2e7d32; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .report-controls {
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
            align-items: center;
            justify-content: flex-start;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; 
        }
        .input-controls button {
            flex-grow: 1;
            padding: 12px 20px; 
        }

        .input-controls button:first-child {
            flex-grow: 2; 
        }
        
        /* ************************************** */
        /* STYLE BARU UNTUK CHANGELOG (RIWAYAT PERUBAHAN) */
        /* ************************************** */
        .changelog-section {
            margin-top: 30px;
            padding: 25px;
            border-radius: 10px;
            background-color: #e0f2f1; /* Light Teal Background */
            border: 1px solid #b2dfdb;
        }

        .changelog-section summary {
            font-size: 1.5em;
            font-weight: 700;
            color: #004d40; /* Dark Teal Text */
            cursor: pointer;
            padding: 10px 0;
        }
        
        .changelog-section details[open] summary {
             border-bottom: 2px solid #004d40;
             margin-bottom: 15px;
        }

        .changelog-list {
            list-style-type: none;
            padding: 0;
        }

        .changelog-item {
            padding: 10px 0;
            border-bottom: 1px dashed #b2dfdb;
            line-height: 1.4;
        }

        .changelog-item:last-child {
            border-bottom: none;
        }

        .changelog-item strong {
            color: #3949ab;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Input Data Harian Laporan Pelayanan (Cloud Firestore) <small style="font-size: 0.6em; color: #616161; font-weight: 400;">(Versi 1.2)</small></h1>
        
        <div class="input-section">
            <h2>Input Data Harian</h2>
            <div style="display: flex; flex-wrap: wrap; align-items: center; margin-bottom: 20px; gap: 20px;">
                <label for="tanggal" style="margin-top:0; font-size: 1.1em; width: auto; flex-shrink: 0;">Tanggal:</label>
                <input type="date" id="tanggal" onchange="muatDataTanggal()" required style="width: 250px; margin-bottom: 0;">
            </div>
            
            <div class="input-group">
                <h3>1. Asuransi & Total Pasien</h3>
                
                <div class="input-pair-wrapper">
                    <label for="bpjsRj" class="main-label">Pasien BPJS</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="bpjsRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="bpjsRj" value="0" min="0" oninput="updateTotals()">
                        </div>
                        <div class="input-sub-item">
                            <label for="bpjsRi">Rawat Inap (RI):</label>
                            <input type="number" id="bpjsRi" value="0" min="0" oninput="updateTotals()">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="swastaRj" class="main-label">Pasien Swasta</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="swastaRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="swastaRj" value="0" min="0" oninput="updateTotals()">
                        </div>
                        <div class="input-sub-item">
                            <label for="swastaRi">Rawat Inap (RI):</label>
                            <input type="number" id="swastaRi" value="0" min="0" oninput="updateTotals()">
                        </div>
                    </div>
                </div>
                
                <div class="input-item">
                    <label for="totalPasien">Total Pasien (Semua):</label>
                    <input type="number" id="totalPasien" value="0" min="0" readonly>
                </div>
                <div class="input-item">
                    <label for="totalRi">Total Pasien Rawat Inap:</label>
                    <input type="number" id="totalRi" value="0" min="0" readonly>
                </div>
                <div class="input-item" style="height: 0; margin-bottom: 0; visibility: hidden;"></div> 
            </div>

            <div class="input-group">
                <h3>2. Data Spesialisasi</h3>
                
                <div class="input-pair-wrapper">
                    <label for="pdRi" class="main-label">Penyakit Dalam (PD)</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="pdRi">Rawat Inap (RI):</label>
                            <input type="number" id="pdRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="pdRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="pdRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="bedahRi" class="main-label">Bedah Umum</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="bedahRi">Rawat Inap (RI):</label>
                            <input type="number" id="bedahRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="bedahRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="bedahRj" value="0" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="input-pair-wrapper">
                    <label for="anakRi" class="main-label">Anak</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="anakRi">Rawat Inap (RI):</label>
                            <input type="number" id="anakRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="anakRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="anakRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="syarafRi" class="main-label">Syaraf</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="syarafRi">Rawat Inap (RI):</label>
                            <input type="number" id="syarafRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="syarafRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="syarafRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="obgynRi" class="main-label">Obgyn</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="obgynRi">Rawat Inap (RI):</label>
                            <input type="number" id="obgynRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="obgynRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="obgynRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="orthopediRi" class="main-label">Orthopedi</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="orthopediRi">Rawat Inap (RI):</label>
                            <input type="number" id="orthopediRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="orthopediRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="orthopediRj" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="input-pair-wrapper">
                    <label for="mataRi" class="main-label">Mata</label>
                    <div class="input-sub-pair">
                        <div class="input-sub-item">
                            <label for="mataRi">Rawat Inap (RI):</label>
                            <input type="number" id="mataRi" value="0" min="0">
                        </div>
                        <div class="input-sub-item">
                            <label for="mataRj">Rawat Jalan (RJ):</label>
                            <input type="number" id="mataRj" value="0" min="0">
                        </div>
                    </div>
                </div>
                <div class="input-pair-wrapper" style="height: 0; margin-bottom: 0; visibility: hidden; padding: 0; border: none; background: none;"></div> 
            </div>

            <div class="input-group">
                <h3>3. Kejadian Khusus (Disertai Keterangan Multi-Baris)</h3>
                
                <div class="input-khusus-wrapper">
                    <label for="dirujuk" class="main-label-khusus">Pasien Dirujuk:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="dirujuk">Jumlah:</label>
                            <input type="number" id="dirujuk" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="dirujukKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="dirujukKeterangan" placeholder="Cth:&#10;1. Pasien A dirujuk ke RSUD X&#10;2. Pasien B dirujuk ke RS Y"></textarea>
                        </div>
                    </div>
                </div>

                <div class="input-khusus-wrapper">
                    <label for="ditolak" class="main-label-khusus">Pasien Ditolak:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="ditolak">Jumlah:</label>
                            <input type="number" id="ditolak" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="ditolakKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="ditolakKeterangan" placeholder="Cth:&#10;1. 1 kasus karena IGD penuh&#10;2. 1 kasus karena tidak ada kamar"></textarea>
                        </div>
                    </div>
                </div>

                <div class="input-khusus-wrapper">
                    <label for="rujukanMasuk" class="main-label-khusus">Pasien Rujukan (Masuk):</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="rujukanMasuk">Jumlah:</label>
                            <input type="number" id="rujukanMasuk" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="rujukanMasukKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="rujukanMasukKeterangan" placeholder="Cth:&#10;1. Rujukan dari Puskesmas X (DHF)&#10;2. Rujukan dari Bidan Y"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="input-khusus-wrapper">
                    <label for="meninggal" class="main-label-khusus">Pasien Meninggal < 8 Jam:</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="meninggal">Jumlah:</label>
                            <input type="number" id="meninggal" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="meninggalKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="meninggalKeterangan" placeholder="Cth:&#10;1. Tn. A (Gagal Nafas)&#10;2. An. B (DHF Syok)"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="input-khusus-wrapper">
                    <label for="doa" class="main-label-khusus">Pasien DOA (Dead on Arrival):</label>
                    <div class="input-sub-pair-khusus">
                        <div class="input-khusus-jumlah">
                            <label for="doa">Jumlah:</label>
                            <input type="number" id="doa" value="0" min="0">
                        </div>
                        <div class="input-khusus-keterangan">
                            <label for="doaKeterangan">Keterangan (Opsional, Multi-Baris):</label>
                            <textarea id="doaKeterangan" placeholder="Cth:&#10;1. Kecelakaan Lalu Lintas (Trauma Berat)&#10;2. Gantung Diri"></textarea>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div class="input-controls">
                <button onclick="tambahData()">‚úÖ Simpan/Perbarui Data Harian</button>
                <button onclick="hapusDataPerTanggal()" class="delete-date-button">‚ùå Hapus Data Tanggal Ini</button>
                <button onclick="resetInputFields(true)" class="reset-button">üîÑ Reset Input</button>
                <button onclick="hapusSemuaData()" class="delete-button">üóëÔ∏è Hapus Semua Data</button>
            </div>
        </div>

        <div class="report-section">
            <h2>Laporan Data Bulanan (Tanggal ke Samping)</h2>
            
            <div id="chart-container" style="max-width: 100%; height: 350px; margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background-color: #ffffff;">
                <canvas id="monthly-chart"></canvas>
            </div>
            <div class="report-controls">
                <select id="bulan-filter" onchange="tampilkanLaporan()"></select>
                <button onclick="eksporLaporanXLSX_Transpose()" class="export-button" style="background-color: #1a237e;">
                    üì• Ekspor XLSX (Landscape)
                </button>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="laporan-tabel"></table>
            </div>
            
            <div id="total-nilai"></div>
        </div>
        
        <div class="changelog-section">
            <details>
                <summary>Riwayat Perubahan Aplikasi (Versi 1.2)</summary>
                <ul id="changelog-list-app" class="changelog-list">
                    <li class="changelog-item">
                        <strong>Versi 1.2 Update (Baru):</strong> Mengubah urutan kolom input Rawat Jalan (RJ) dan Rawat Inap (RI) di bagian 'Data Spesialisasi' menjadi **Rawat Inap (RI) &rarr; Rawat Jalan (RJ)** (sesuai permintaan user).
                    </li>
                    <li class="changelog-item">
                        <strong>1. Pindah Server (Versi 1.0):</strong> Menggunakan **Firebase Cloud Firestore** untuk menyimpan data harian.
                    </li>
                    <li class="changelog-item">
                        <strong>2. Pembaruan Laporan Visual (Versi 1.0):</strong> Perubahan tampilan grafik kunjungan pasien bulanan (menggunakan Chart.js).
                    </li>
                    <li class="changelog-item">
                        <strong>3. Format Ekspor Baru (Versi 1.0):</strong> Mengganti format file hasil laporan menjadi **XLSX** (sebelumnya CSV).
                    </li>
                    <li class="changelog-item">
                        <strong>4. Hapus Fungsi Lama (Versi 1.0):</strong> Menghapus fungsi ekspor file format CSV.
                    </li>
                </ul>
            </details>
            
            <details style="margin-top: 10px;">
                <summary style="font-size: 1.2em; font-weight: 600; color: #3949ab;">Riwayat Update Data Harian Terakhir</summary>
                <ul id="changelog-list" class="changelog-list">
                    <li>Memuat data perubahan...</li>
                </ul>
            </details>
        </div>
        </div>

    <script>
        // 2. KONFIGURASI DAN INISIALISASI FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyD4CJjUxraBYsuBMPf8mJKOJI8-wbLGedQ",
            authDomain: "laporan-bulanan-b79f3.firebaseapp.com",
            projectId: "laporan-bulanan-b79f3",
            storageBucket: "laporan-bulanan-b79f3.firebasestorage.app",
            messagingSenderId: "662666112252",
            appId: "1:662666112252:web:31a296f176c6aead353b79",
            measurementId: "G-5S04HKJEL1"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const COLLECTION_NAME = 'laporanHarian'; // Nama koleksi di Firestore
        
        // Daftar semua ID input angka dan textarea (keterangan)
        const INPUT_IDS = [
            'bpjsRj', 'bpjsRi', 'swastaRj', 'swastaRi', 'totalPasien', 'totalRi', 
            'pdRj', 'pdRi', 'bedahRj', 'bedahRi', 'anakRj', 'anakRi', 'syarafRj', 'syarafRi', 
            'obgynRj', 'obgynRi', 'orthopediRj', 'orthopediRi', 'mataRj', 'mataRi',
            'dirujuk', 'dirujukKeterangan', 
            'ditolak', 'ditolakKeterangan', 
            'rujukanMasuk', 'rujukanMasukKeterangan', 
            'meninggal', 'meninggalKeterangan', 
            'doa', 'doaKeterangan' 
        ];

        const dataKeysReport = [
            "tanggal", "bpjsRj", "bpjsRi", "swastaRj", "swastaRi", "totalPasien", "totalRi", 
            "pdRj", "pdRi", "bedahRj", "bedahRi", "anakRj", "anakRi", "syarafRj", "syarafRi", "obgynRj", "obgynRi", "orthopediRj", "orthopediRi", "mataRj", "mataRi",
            "dirujuk", "dirujukKeterangan", 
            "ditolak", "ditolakKeterangan", 
            "rujukanMasuk", "rujukanMasukKeterangan", 
            "meninggal", "meninggalKeterangan", 
            "doa", "doaKeterangan"
        ];
        
        const rowClassMap = {
            "BPJS RJ": "row-rj",
            "BPJS RI": "row-ri",
            "Swasta RJ": "row-rj",
            "Swasta RI": "row-ri",
            "Total Pasien": "row-umum",
            "Total RI": "row-umum",
            
            "PD RJ": "row-rj",
            "PD RI": "row-ri",
            "Bedah RJ": "row-rj",
            "Bedah RI": "row-ri",
            "Anak RJ": "row-rj",
            "Anak RI": "row-ri",
            "Syaraf RJ": "row-rj",
            "Syaraf RI": "row-ri",
            "Obgyn RJ": "row-rj",
            "Obgyn RI": "row-ri",
            "Orthopedi RJ": "row-rj",
            "Orthopedi RI": "row-ri",
            "Mata RJ": "row-rj",
            "Mata RI": "row-ri",
            
            "Dirujuk": "row-khusus",
            "Ket. Dirujuk": "row-khusus",
            "Ditolak": "row-khusus",
            "Ket. Ditolak": "row-khusus",
            "Rujukan Masuk": "row-khusus",
            "Ket. Masuk": "row-khusus",
            "Meninggal <8J": "row-khusus",
            "Ket. Meninggal": "row-khusus",
            "DOA": "row-khusus",
            "Ket. DOA": "row-khusus"
        };
        
        const kolomHeader = [
            "Tanggal", 
            "BPJS RJ", "BPJS RI", "Swasta RJ", "Swasta RI", "Total Pasien", "Total RI", 
            "PD RJ", "PD RI", "Bedah RJ", "Bedah RI", "Anak RJ", "Anak RI", "Syaraf RJ", "Syaraf RI", "Obgyn RJ", "Obgyn RI", "Orthopedi RJ", "Orthopedi RI", "Mata RJ", "Mata RI",
            "Dirujuk", "Ket. Dirujuk", 
            "Ditolak", "Ket. Ditolak", 
            "Rujukan Masuk", "Ket. Masuk", 
            "Meninggal <8J", "Ket. Meninggal", 
            "DOA", "Ket. DOA"
        ];
        
        // --- START: FUNGSI BARU UNTUK CHANGELOG DATA ---

        // Helper untuk memformat timestamp dari Firebase
        function formatTimestamp(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'Tanggal tidak valid';
            const date = timestamp.toDate();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit' 
            };
            return date.toLocaleString('id-ID', options);
        }

        // FUNGSI FIREBASE: MUAT RIWAYAT PERUBAHAN (CHANGELOG DATA)
        async function muatChangelog() {
            // Menggunakan ID yang ditargetkan di HTML: id="changelog-list"
            const listElement = document.getElementById('changelog-list');
            listElement.innerHTML = '<li>Memuat data perubahan...</li>';

            try {
                // Ambil 10 dokumen terbaru, diurutkan berdasarkan timestamp (last update/creation)
                const snapshot = await db.collection(COLLECTION_NAME)
                                         .orderBy('timestamp', 'desc')
                                         .limit(10)
                                         .get();
                                         
                let htmlList = '';
                if (snapshot.empty) {
                    htmlList = '<li>Belum ada data harian yang tersimpan di Cloud Firestore.</li>';
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const tanggal = data.tanggal;
                        const timestamp = data.timestamp;

                        // Hitung total pasien untuk ditampilkan di changelog
                        const totalPasien = (data.totalPasien || 0); // Ambil dari field totalPasien yang dihitung
                        
                        // Format tanggal dan waktu
                        const waktuUpdate = formatTimestamp(timestamp);

                        htmlList += `
                            <li class="changelog-item">
                                <strong>Laporan Tanggal: ${tanggal.split('-').reverse().join('/')}</strong> (Total Pasien: ${totalPasien.toLocaleString('id-ID')})
                                <br>
                                <small>Terakhir Disimpan/Diperbarui: ${waktuUpdate}</small>
                            </li>
                        `;
                    });
                }
                listElement.innerHTML = htmlList;

            } catch (error) {
                console.error("Gagal memuat changelog: ", error);
                listElement.innerHTML = '<li>Gagal memuat riwayat perubahan data. Cek konsol.</li>';
            }
        }
        // --- END: FUNGSI BARU UNTUK CHANGELOG DATA ---


        // FUNGSI LOKAL: Kalkulasi Otomatis Total
        function updateTotals() {
            const bpjsRj = parseInt(document.getElementById('bpjsRj').value) || 0;
            const bpjsRi = parseInt(document.getElementById('bpjsRi').value) || 0;
            const swastaRj = parseInt(document.getElementById('swastaRj').value) || 0;
            const swastaRi = parseInt(document.getElementById('swastaRi').value) || 0;

            const totalPasien = bpjsRj + bpjsRi + swastaRj + swastaRi;
            const totalRi = bpjsRi + swastaRi; 

            document.getElementById('totalPasien').value = totalPasien;
            document.getElementById('totalRi').value = totalRi;
        }

        // FUNGSI FIREBASE BARU: AMBIL SEMUA DATA (untuk Laporan)
        async function ambilSemuaDataLaporan() {
            try {
                // Ambil semua dokumen, diurutkan berdasarkan field 'tanggal'
                const snapshot = await db.collection(COLLECTION_NAME).orderBy('tanggal').get();
                const semuaData = [];
                snapshot.forEach(doc => {
                    semuaData.push(doc.data());
                });
                return semuaData;
            } catch (error) {
                console.error("Gagal mengambil semua data dari Firebase: ", error);
                alert("Gagal memuat data laporan dari cloud. Lihat konsol untuk detail.");
                return []; 
            }
        }
        
        // FUNGSI FIREBASE: MUAT DATA PER TANGGAL (READ)
        async function muatDataTanggal() {
            const tanggalInput = document.getElementById('tanggal').value;
            
            if (!tanggalInput) {
                resetInputFields(false);
                updateTotals();
                return;
            }

            try {
                const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                const doc = await docRef.get();

                if (doc.exists) {
                    const dataDitemukan = doc.data();
                    INPUT_IDS.forEach(id => {
                        const inputElement = document.getElementById(id);
                        if (inputElement) {
                            // Memuat angka atau teks/textarea (keterangan)
                            inputElement.value = dataDitemukan[id] !== undefined ? dataDitemukan[id] : 
                                (inputElement.tagName === 'INPUT' && inputElement.type === 'number' ? 0 : '');
                        }
                    });
                    console.log(`Data untuk tanggal ${tanggalInput} berhasil dimuat dari Firestore.`);
                } else {
                    resetInputFields(false); 
                    console.log(`Tidak ada data tersimpan untuk tanggal ${tanggalInput} di Firestore.`);
                }
            } catch (error) {
                 console.error("Gagal memuat data dari Firebase: ", error);
                 alert("Gagal memuat data. Lihat konsol untuk detailnya.");
            }
            // PENTING: Panggil updateTotals setelah memuat atau mereset data
            updateTotals();
        }

        // FUNGSI FIREBASE: HAPUS DATA PER TANGGAL (DELETE)
        async function hapusDataPerTanggal() {
            const tanggalInput = document.getElementById('tanggal').value;
            
            if (!tanggalInput) {
                alert("Pilih tanggal terlebih dahulu untuk menghapus datanya!");
                return;
            }

            if (confirm(`Anda yakin ingin menghapus data untuk tanggal ${tanggalInput} dari Cloud Firestore? Aksi ini tidak bisa dibatalkan!`)) {
                try {
                    const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                    await docRef.delete();
                    
                    alert(`Data untuk tanggal ${tanggalInput} berhasil dihapus dari Cloud Firestore.`);
                    resetInputFields(false); 
                    await inisialisasiBulanFilter(); // Memuat ulang filter dan laporan
                    await tampilkanLaporan(); 
                    await muatChangelog(); // REFRESH CHANGELOG
                } catch (error) {
                    console.error("Gagal menghapus data dari Firebase: ", error);
                    alert("Gagal menghapus data. Pastikan Anda memiliki koneksi dan izin. Lihat konsol untuk detail.");
                }
            }
        }

        function resetInputFields(konfirmasiUser = true) {
            let lanjutkan = true;
            if (konfirmasiUser) {
                 lanjutkan = confirm("Anda yakin ingin MERESET semua kolom input data menjadi nilai 0/kosong?");
            }
            
            if (lanjutkan) {
                const numberInputs = document.querySelectorAll('input[type="number"]');
                const textInputs = document.querySelectorAll('textarea');
                
                numberInputs.forEach(input => {
                    // Hanya reset input yang BUKAN readonly
                    if (!input.hasAttribute('readonly')) {
                         input.value = 0;
                    }
                });
                
                textInputs.forEach(input => {
                    input.value = '';
                });

                // PENTING: Panggil updateTotals setelah reset
                updateTotals(); 
                
                if (konfirmasiUser) {
                    alert("Semua kolom input data telah direset menjadi 0/kosong.");
                }
            }
        }

        // FUNGSI FIREBASE: HAPUS SEMUA DATA (DELETE BATCH - sederhana)
        async function hapusSemuaData() {
            if (!confirm("PERINGATAN! ANDA YAKIN INGIN MENGHAPUS SEMUA DATA LAPORAN SECARA PERMANEN DARI CLOUD? Aksi ini tidak bisa dibatalkan!")) {
                return;
            }
            
            try {
                const batch = db.batch();
                const snapshot = await db.collection(COLLECTION_NAME).get();
                let count = 0;

                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                    count++;
                });

                await batch.commit();
                alert(`Semua ${count} data laporan telah berhasil dihapus dari Cloud Firestore.`);
                
                resetInputFields(false); 
                await inisialisasiBulanFilter(); 
                await tampilkanLaporan();  
                await muatChangelog(); // REFRESH CHANGELOG    
            } catch (error) {
                console.error("Gagal menghapus semua data dari Firebase: ", error);
                alert("Gagal menghapus semua data. Lihat konsol untuk detail.");
            }
        }

        // FUNGSI FIREBASE: SIMPAN/PERBARUI DATA (CREATE/UPDATE)
        async function tambahData() {
            const tanggalInput = document.getElementById('tanggal').value;

            if (!tanggalInput) {
                alert("Tanggal wajib diisi!");
                return;
            }

            updateTotals(); // Pastikan nilai total Pasien dan RI sudah yang terbaru

            // --- START: VALIDASI KONSISTENSI DATA --- (Sama seperti sebelumnya)
            const bpjsRj = parseInt(document.getElementById('bpjsRj').value) || 0;
            const bpjsRi = parseInt(document.getElementById('bpjsRi').value) || 0;
            const swastaRj = parseInt(document.getElementById('swastaRj').value) || 0;
            const swastaRi = parseInt(document.getElementById('swastaRi').value) || 0;

            const totalRjAsuransi = bpjsRj + swastaRj;
            const totalRiAsuransi = bpjsRi + swastaRi;

            const totalRjSpesialisasi = 
                (parseInt(document.getElementById('pdRj').value) || 0) +
                (parseInt(document.getElementById('bedahRj').value) || 0) +
                (parseInt(document.getElementById('anakRj').value) || 0) +
                (parseInt(document.getElementById('syarafRj').value) || 0) +
                (parseInt(document.getElementById('obgynRj').value) || 0) +
                (parseInt(document.getElementById('orthopediRj').value) || 0) +
                (parseInt(document.getElementById('mataRj').value) || 0);

            const totalRiSpesialisasi = 
                (parseInt(document.getElementById('pdRi').value) || 0) +
                (parseInt(document.getElementById('bedahRi').value) || 0) +
                (parseInt(document.getElementById('anakRi').value) || 0) +
                (parseInt(document.getElementById('syarafRi').value) || 0) +
                (parseInt(document.getElementById('obgynRi').value) || 0) +
                (parseInt(document.getElementById('orthopediRi').value) || 0) +
                (parseInt(document.getElementById('mataRi').value) || 0);

            let errorMessages = [];

            if (totalRjAsuransi !== totalRjSpesialisasi) {
                errorMessages.push(`‚ùå Total Pasien Rawat Jalan (Asuransi: ${totalRjAsuransi}) TIDAK SAMA dengan Total Pasien Rawat Jalan (Spesialisasi: ${totalRjSpesialisasi}).`);
            }

            if (totalRiAsuransi !== totalRiSpesialisasi) {
                errorMessages.push(`‚ùå Total Pasien Rawat Inap (Asuransi: ${totalRiAsuransi}) TIDAK SAMA dengan Total Pasien Rawat Inap (Spesialisasi: ${totalRiSpesialisasi}).`);
            }

            if (errorMessages.length > 0) {
                const konfirmasiLanjut = confirm("‚ö†Ô∏è Data Pasien Tidak Konsisten! \n\n" + errorMessages.join('\n') + "\n\nApakah Anda yakin ingin tetap menyimpan data ini?");
                if (!konfirmasiLanjut) {
                    alert("Penyimpanan data dibatalkan. Mohon periksa kembali kolom Asuransi dan Spesialisasi.");
                    return;
                }
            }
            // --- END: VALIDASI KONSISTENSI DATA ---

            // Mengambil nilai dari semua input (angka dan textarea)
            const dataBaru = { 
                tanggal: tanggalInput,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Tambahkan timestamp
            };
            INPUT_IDS.forEach(id => {
                 const inputElement = document.getElementById(id);
                 if (inputElement.tagName === 'INPUT' && inputElement.type === 'number') {
                    dataBaru[id] = parseInt(inputElement.value) || 0;
                 } else if (inputElement.tagName === 'TEXTAREA') {
                    dataBaru[id] = inputElement.value.trim(); 
                 }
            });
            
            try {
                 const docRef = db.collection(COLLECTION_NAME).doc(tanggalInput);
                 const doc = await docRef.get();

                 let konfirmasiPesan;
                 if (doc.exists) {
                     konfirmasiPesan = `Anda yakin ingin MEMPERBARUI data untuk tanggal ${tanggalInput} di Cloud Firestore?`;
                 } else {
                     konfirmasiPesan = `Anda yakin ingin MENYIMPAN data baru untuk tanggal ${tanggalInput} di Cloud Firestore?`;
                 }

                 if (confirm(konfirmasiPesan)) {
                     // Menggunakan set() dengan ID dokumen = tanggalInput (Otomatis Create/Update)
                     await docRef.set(dataBaru);
                     alert(`Data untuk tanggal ${tanggalInput} berhasil disimpan/diperbarui di Cloud Firestore!`);

                     await inisialisasiBulanFilter(); 
                     await tampilkanLaporan(); 
                     await muatChangelog(); // REFRESH CHANGELOG
                 } else {
                      alert("Penyimpanan/Pembaruan data dibatalkan.");
                 }
            } catch (error) {
                console.error("Gagal menyimpan data ke Firebase: ", error);
                alert("Gagal menyimpan data. Pastikan Anda memiliki koneksi dan izin. Lihat konsol untuk detail.");
            }
        }
        
        let monthlyChart = null; 

        function buatChartLaporan(dataBulanIni) {
            const ctx = document.getElementById('monthly-chart').getContext('2d');
            
            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const dates = dataBulanIni.map(item => item.tanggal.split('-').reverse().join('/'));
            const totalPasienHarian = dataBulanIni.map(item => item.totalPasien);

            monthlyChart = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Total Pasien Harian',
                        data: totalPasienHarian,
                        backgroundColor: 'rgba(66, 165, 245, 0.5)',
                        borderColor: 'rgb(66, 165, 245)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'üìà Tren Total Pasien Harian Bulan Ini',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Pasien'
                            }
                        }
                    }
                }
            });
        }


        // FUNGSI FIREBASE: INISIALISASI FILTER BULAN
        async function inisialisasiBulanFilter() {
            const data = await ambilSemuaDataLaporan();
            const filter = document.getElementById('bulan-filter');
            filter.innerHTML = ''; 

            const bulanTersedia = new Set();
            data.forEach(item => {
                const [tahun, bulan] = item.tanggal.split('-');
                bulanTersedia.add(`${tahun}-${bulan}`);
            });

            const bulanArray = Array.from(bulanTersedia).sort().reverse();
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Pilih Bulan --';
            filter.appendChild(defaultOption);

            bulanArray.forEach(bulanTahun => {
                const option = document.createElement('option');
                option.value = bulanTahun;
                const [tahun, bulan] = bulanTahun.split('-');
                const namaBulan = new Date(tahun, bulan - 1).toLocaleString('id-ID', { month: 'long' });
                option.textContent = `${namaBulan} ${tahun}`;
                filter.appendChild(option);
            });

            // Set filter ke bulan terbaru
            if (bulanArray.length > 0) {
                filter.value = bulanArray[0];
            }
        }

        // FUNGSI FIREBASE: TAMPILKAN LAPORAN (READ)
        async function tampilkanLaporan() {
            const bulanFilter = document.getElementById('bulan-filter').value;
            const tabelContainer = document.getElementById('laporan-tabel');
            const totalDiv = document.getElementById('total-nilai');
            
            // Ambil semua data dari Cloud
            const semuaData = await ambilSemuaDataLaporan();
            tabelContainer.innerHTML = '';
            totalDiv.textContent = '';
            
            if (!bulanFilter) {
                totalDiv.textContent = 'Silahkan pilih bulan untuk menampilkan laporan.';
                if (monthlyChart) monthlyChart.destroy();
                return;
            }

            const dataBulanIni = semuaData.filter(item => item.tanggal.startsWith(bulanFilter));

            if (dataBulanIni.length === 0) {
                tabelContainer.innerHTML = '<thead><tr><th>Kategori</th></tr></thead><tbody><tr><td colspan="31" style="text-align:center;">Tidak ada data untuk bulan yang dipilih.</td></tr></tbody>';
                if (monthlyChart) monthlyChart.destroy();
                return;
            }

            // Data Keys & Headers (Filter keluar 'Tanggal')
            const reportDataKeys = dataKeysReport.slice(1);
            const reportKolomHeader = kolomHeader.slice(1);
            
            // 1. Ambil list tanggal untuk kolom (untuk tampilan HTML, tetap format DD/MM/YYYY)
            const dates = dataBulanIni.map(item => item.tanggal.split('-').reverse().join('/')); 

            // 2. Buat Header Tabel (Tanggal)
            const headerRow = tabelContainer.createTHead().insertRow();
            
            let th = document.createElement('th');
            th.textContent = 'Kategori';
            th.style.minWidth = '150px'; 
            headerRow.appendChild(th);

            dates.forEach(date => {
                th = document.createElement('th');
                th.textContent = date;
                headerRow.appendChild(th);
            });

            th = document.createElement('th');
            th.textContent = 'TOTAL BULAN';
            th.style.backgroundColor = '#1a237e'; 
            headerRow.appendChild(th);

            // 3. Buat Body Tabel (Metrik sebagai Baris)
            const tabelBody = tabelContainer.createTBody();
            
            let totalPasienBulanIni = 0;

            reportKolomHeader.forEach((displayHeader, index) => {
                const dataKey = reportDataKeys[index]; 
                const row = tabelBody.insertRow();
                
                const rowClass = rowClassMap[displayHeader] || 'row-umum';
                row.classList.add(rowClass);

                // Cell 1: Nama Metrik
                let cell = row.insertCell();
                cell.textContent = displayHeader;
                cell.style.fontWeight = 'bold';
                
                let totalMetric = 0;
                
                // Loop melalui setiap hari/kolom
                dataBulanIni.forEach(dayData => {
                    cell = row.insertCell();
                    const value = dayData[dataKey];

                    if (displayHeader.includes('Ket.')) {
                        // Data Teks/Keterangan
                        cell.textContent = value || '-';
                        cell.classList.add('keterangan-cell');
                        cell.style.textAlign = 'left';
                        
                    } else {
                        // Data Numerik
                        const numValue = parseInt(value) || 0;
                        cell.textContent = numValue;
                        cell.style.textAlign = 'right';
                        totalMetric += numValue;
                        
                        if (dataKey === 'totalPasien') {
                            totalPasienBulanIni += numValue;
                        }
                    }
                });
                
                // Last Cell: Total Bulan
                cell = row.insertCell();
                if (displayHeader.includes('Ket.')) {
                    cell.textContent = '-'; 
                    cell.style.textAlign = 'center';
                    cell.classList.add('keterangan-cell');
                } else {
                    cell.textContent = totalMetric.toLocaleString('id-ID');
                    cell.style.textAlign = 'right';
                    cell.classList.add('total-row'); 
                }
            });

            // 4. Update Grand Total (Div di bawah tabel)
            totalDiv.textContent = `TOTAL PASIEN BULAN INI: ${totalPasienBulanIni.toLocaleString('id-ID')}`;
            
            // 5. Tambahkan Baris TOTAL HARIAN (Grand Total Harian)
            const totalHarianRow = tabelBody.insertRow();
            // Gunakan class total-row yang sudah ada, lalu override warna latar
            totalHarianRow.classList.add('total-row'); 
            totalHarianRow.style.backgroundColor = '#e8f5e9'; // Light green background (matching XLSX grand total)

            // Cell 1: Label
            let cellLabel = totalHarianRow.insertCell();
            cellLabel.textContent = 'TOTAL HARIAN (Semua Pasien)';
            cellLabel.style.textAlign = 'left';
            cellLabel.style.fontWeight = 'bold';

            // Loop melalui setiap hari/kolom untuk menampilkan daily total
            dataBulanIni.forEach(dayData => {
                let cellTotal = totalHarianRow.insertCell();
                const dailyTotal = dayData.totalPasien || 0; 
                cellTotal.textContent = dailyTotal.toLocaleString('id-ID');
                cellTotal.style.textAlign = 'right';
                cellTotal.style.fontWeight = 'bold';
                cellTotal.style.backgroundColor = '#c5cae9'; // Light blue for daily total emphasis
            });

            // Cell Terakhir: Grand Total Bulanan
            let cellGrandTotal = totalHarianRow.insertCell();
            cellGrandTotal.textContent = totalPasienBulanIni.toLocaleString('id-ID');
            cellGrandTotal.style.textAlign = 'right';
            cellGrandTotal.style.fontWeight = 'bold';
            cellGrandTotal.style.backgroundColor = '#2e7d32'; // Dark green
            cellGrandTotal.style.color = 'white';

            // 6. Panggil fungsi Chart untuk menampilkan visualisasi
            buatChartLaporan(dataBulanIni); 
        }

        // FUNGSI EKSPOR XLSX (LANDSCAPE/TRANSPOSE)
        async function eksporLaporanXLSX_Transpose() {
            const bulanFilter = document.getElementById('bulan-filter').value;
            if (!bulanFilter) {
                alert("Pilih bulan terlebih dahulu untuk diekspor!");
                return;
            }

            const semuaData = await ambilSemuaDataLaporan();
            const dataBulanIni = semuaData.filter(item => item.tanggal.startsWith(bulanFilter));
            
            if (dataBulanIni.length === 0) {
                 alert("Tidak ada data untuk diekspor.");
                 return;
            }

            // Data Keys & Headers (Filter keluar 'Tanggal' karena akan jadi Header Baris)
            const reportDataKeys = dataKeysReport.slice(1);
            const reportKolomHeader = kolomHeader.slice(1); 

            // 1. Persiapan Data Transpose
            let finalDataXLSX = [];
            
            // a. Buat Header Kolom Pertama: Kategori, diikuti oleh Tanggal (Hanya Hari), lalu Total Bulan
            const dates = dataBulanIni.map(item => item.tanggal.split('-')[2]); 
            
            const headerRow = ["Kategori", ...dates, "TOTAL BULAN"];
            finalDataXLSX.push(headerRow);
            
            // Array untuk menyimpan Total Pasien Harian (untuk dihitung Grand Totalnya di akhir)
            let totalPasienBulanIni = 0; 

            reportKolomHeader.forEach((displayHeader, index) => {
                const dataKey = reportDataKeys[index]; 
                const row = [displayHeader]; // Mulai baris dengan nama Kategori
                
                let totalMetric = 0;
                
                // Loop melalui setiap hari/kolom
                dataBulanIni.forEach(dayData => {
                    const value = dayData[dataKey];

                    if (displayHeader.includes('Ket.')) {
                        // Data Teks/Keterangan
                        const ketValue = String(value || '').replace(/\n/g, ' | '); // Membersihkan keterangan multi-baris
                        row.push(ketValue);
                    } else {
                        // Data Numerik
                        const numValue = parseInt(value) || 0;
                        row.push(numValue);
                        totalMetric += numValue;
                        
                        // Hanya menghitung grand total untuk baris 'totalPasien'
                        if (dataKey === 'totalPasien') {
                            totalPasienBulanIni += numValue;
                        }
                    }
                });
                
                // Tambahkan Total Bulan di akhir baris
                row.push(displayHeader.includes('Ket.') ? '' : totalMetric); // Keterangan tidak di-total
                
                finalDataXLSX.push(row);
            });

            // c. Tambahkan Baris Grand Total
            let totalHarianRow = ["TOTAL HARIAN"]; 
            
            // Kita harus mencari index baris 'totalPasien' di array finalDataXLSX
            const totalPasienDataIndex = reportDataKeys.indexOf('totalPasien'); 

            dates.forEach((date, dateIndex) => {
                // Ambil data dari baris yang sudah diolah (finalDataXLSX[totalPasienDataIndex + 1])
                // dateIndex + 1 karena index 0 adalah 'Kategori'
                const dailyTotal = finalDataXLSX[totalPasienDataIndex + 1] ? finalDataXLSX[totalPasienDataIndex + 1][dateIndex + 1] : 0; 
                totalHarianRow.push(dailyTotal || 0);
            });
            totalHarianRow.push(totalPasienBulanIni); // Total Pasien Bulanan
            finalDataXLSX.push(totalHarianRow);

            // 2. Buat Workbook XLSX
            const ws = XLSX.utils.aoa_to_sheet(finalDataXLSX); 
            
            // --- START: MODIFIKASI STYLING XLSX (Warna dan Freeze Pane) ---
            
            // Styles definition
            const styles = {
                header: { fill: { patternType: "solid", fgColor: { rgb: "3949AB" } }, font: { color: { rgb: "FFFFFF" }, bold: true } }, // Biru Tua (Header)
                totalBulan: { fill: { patternType: "solid", fgColor: { rgb: "E8EAF6" } }, font: { bold: true } }, // Biru Muda (Kolom Total)
                grandTotal: { fill: { patternType: "solid", fgColor: { rgb: "E8F5E9" } }, font: { bold: true, color: { rgb: "2E7D32" } } }, // Hijau Muda (Baris Grand Total)
                rj: { fill: { patternType: "solid", fgColor: { rgb: "FFFDE7" } } }, // Krem Muda (RJ)
                ri: { fill: { patternType: "solid", fgColor: { rgb: "E0F7FA" } } }, // Biru Muda (RI)
                khusus: { fill: { patternType: "solid", fgColor: { rgb: "FFE0B2" } } } // Oranye Muda (Khusus)
            };

            // Terapkan Style pada Sel
            for (let R = 0; R < finalDataXLSX.length; ++R) {
                const rowData = finalDataXLSX[R];
                const category = String(rowData[0]); 

                for (let C = 0; C < rowData.length; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = ws[cellAddress]; 

                    if (cell) {
                        let cellStyle = {};
                        
                        if (R === 0) {
                            // Style untuk Baris Header (Baris 1)
                            cellStyle = styles.header;
                        } else if (category === 'TOTAL HARIAN') {
                            // Style untuk Baris Grand Total (Baris terakhir)
                            if (C === rowData.length - 1) {
                                 // Kolom Total Bulanan di Grand Total
                                 cellStyle = { ...styles.grandTotal, fill: styles.grandTotal.fill, font: { ...styles.grandTotal.font, color: { rgb: "FFFFFF" } } };
                            } else {
                                 // Kolom Total Harian
                                 cellStyle = styles.grandTotal; 
                            }
                            
                        } else if (C === rowData.length - 1) {
                            // Style untuk Kolom TOTAL BULAN (Kolom terakhir)
                            cellStyle = styles.totalBulan;
                        } else {
                            // Style Latar Belakang berdasarkan Kategori
                            if (category.includes('RJ') && !category.includes('Ket.')) {
                                cellStyle = styles.rj;
                            } else if (category.includes('RI') && !category.includes('Ket.')) {
                                cellStyle = styles.ri;
                            } else if (category.includes('Dirujuk') || category.includes('Ditolak') || category.includes('Rujukan Masuk') || category.includes('Meninggal') || category.includes('DOA') || category.includes('Ket.')) {
                                 cellStyle = styles.khusus;
                            }
                        }
                        
                        // Menerapkan style dengan menggabungkan style yang sudah ada (misalnya number format 'z')
                        cell.s = { ...cell.s, ...cellStyle }; 
                    }
                }
            }

            // Tambahkan Fitur 'Freeze Pane' pada Header dan Kolom Kategori
            ws['!freeze'] = { xSplit: 1, ySplit: 1 };
            
            // --- END: MODIFIKASI STYLING XLSX ---


            // PENTING: Penyesuaian Lebar Kolom
            const wscols = [];
            wscols.push({wch: 25}); // Kolom A (Kategori): Lebar 25
            for(let i = 0; i < dates.length; i++) {
                 wscols.push({wch: 6}); // Kolom Tanggal: Lebar 6 (Lebih kecil karena hanya angka)
            }
            wscols.push({wch: 15}); // Kolom Terakhir (TOTAL BULAN): Lebar 15
            ws['!cols'] = wscols;

            // *** KONFIGURASI PENGATURAN CETAK (PRINT LAYOUT) ***
            if (!ws['!page']) ws['!page'] = {};
            
            // 1. Atur Orientasi ke LANDSCAPE
            ws['!page'].orientation = 'landscape'; 

            // 2. Atur Fit-to-Page (agar muat di satu lebar kertas)
            ws['!page'].fitToPage = true;   
            ws['!page'].fitToWidth = 1;     // Paksa agar lebar data hanya 1 halaman
            ws['!page'].fitToHeight = 0;    // Biarkan tinggi menyesuaikan

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Transpose");

            // 3. Tentukan Nama File dan Unduh
            const [tahun, bulan] = bulanFilter.split('-');
            const namaFile = `Laporan_Transpose_XLSX_Compact_${tahun}_${bulan}.xlsx`;
            
            XLSX.writeFile(wb, namaFile);
            
            alert(`Laporan XLSX Transpose Compact untuk bulan ${bulanFilter} berhasil diekspor.`);
        }

        window.onload = async function() {
            // Set tanggal hari ini
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const defaultDate = `${year}-${month}-${day}`;
            
            document.getElementById('tanggal').value = defaultDate;
            
            // Memuat data dari Firebase
            await muatDataTanggal(); 
            // Memuat filter bulan dari data yang ada di Firebase
            await inisialisasiBulanFilter();
            // Menampilkan laporan untuk bulan terbaru
            await tampilkanLaporan();
            // PENTING: Memuat Changelog DATA saat halaman pertama kali dimuat
            await muatChangelog();
        };
    </script>
</body>
</html>
